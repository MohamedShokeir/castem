************************************
* Test Traction 3D
************************************

OPTI ECHO 1 DIME 2 ELEM QUA4;
OPTI MODE AXIS;
OPTI EPSI UTILISATEUR;
OPTI TRAC X;

* important pour MFront : OPTI EPSI UTILISATEUR;

************************************
* Maillage
************************************

P1 = 0. 0. ;
P2 = 1. 0. ;
P3 = 1. 1. ;
P4 = 0. 1. ;
D1 = P1 DROIT 1 P2;
D2 = P2 DROIT 1 P3;
D3 = P3 DROIT 1 P4;
D4 = P4 DROIT 1 P1;
CONT1 = D1 ET D2 ET D3 ET D4;
S1 = SURF CONT1 PLAN;
*X1 = 0. 0. 1.;
*V1 = S1 VOLU TRAN 1 X1;

REPER = D1 ET D4;

*TRACE (S1 ET REPER);

************************************
* Propriétés mécaniques
************************************

* TT = -150.;
* RR0 = (430. '+' (10.*(EXP(-0.019*TT))));
* RRL = (461. '+' (28.*(EXP(-0.016*TT))));
* OPTI SORT SIM_A81_P20;
* YO1 = (197600-(TT*118.8));
* KK0 = MAXI((PROG (80.-(0.5*TT)) 0.));

COE1 = 'MOTS' 'YOUN' 'NU' 'RHO' 'PHI';
STATEV = 'MOTS' 'EERR' 'EEZZ' 'EETT' 'EERZ' 'P';
MOD0 = 'MODELISER' S1 'MECANIQUE' 'ELASTIQUE' 'NON_LINEAIRE'
'UTILISATEUR' 
 'LIB_LOI' 'src/libUmatBehaviour.so' 
'FCT_LOI' 'umatj47_malls'
 'C_MATERIAU' COE1 'C_VARINTER' STATEV ;
MAT0 = 'MATERIAU' MOD0 'YOUN' 70000. 'NU' 0.3 'RHO' 0 'PHI' 0. ;

************************************
* Conditions aux limites
************************************

P5  = 1. 0. ;
P6  = 1. 1. ;
P7  = 0. 1. ;
PM  = (1/2.) (1/2.) ;
*SD  = V1 POIN PLAN P2 P3 P5 0.0001;
*SD2 = V1 POIN PLAN P1 P4 P7 0.0001;
*SF  = V1 POIN PLAN P1 P2 P5 0.0001;
*SF2 = V1 POIN PLAN P3 P6 P7 0.0001;
*SH  = V1 POIN PLAN P5 P6 P7 0.0001;

*CL1 = BLOQ S1 UZ;
*CL2 = BLOQ SF UY;
*CL3 = BLOQ SD UX;
*CL4 = BLOQ SH UZ;

*REL1 = RELA ENSE UX SD2;
*REL2 = RELA ENSE UY SF2;

*CL = CL1 et CL2 et CL3 et CL4;

CL1 = BLOQ UZ D1;  
CL2 = BLOQ UZ D3;

CL = CL1 ET CL2 ;


************************************
* Chargement
************************************

*VAR0 = MANU CHML MOD1 'EEXX' 0. 'EEYY' 0. 'EEZZ' 0. 'EEXY' 0. 
*'EEXZ' 0. 'EEYZ' 0. 'p' 0. ;
VAR0 = MANU CHML MOD0 'EERR' 0. 'EEZZ' 0. 'EETT' 0.
'EERZ' 0. 'P' 0. ;

DEPMAX = 10.;
TFIN0 = 1.;
PAS1 = 0.1;

LTPC = (PROG 0. PAS 1.E-2 1.) ;
LTPS = (PROG 0. PAS 1.E-2 1.) ;

DEP1 = 'DEPI' CL2 DEPMAX ; 
EV0  = 'EVOL' 'MANU' TEMPS ( 'PROG' 0. TFIN0 ) Y ( 'PROG' 0. 1. ) ; 
CHA0 = 'CHAR' 'DIMP' DEP1 EV0 ; 

TAB1 = TABLE;
TAB1.'MOVA' = 'MOT' 'RIEN' ;
* TAB1.'TEMPERATURES' = TABLE ;
TAB1.'VARIABLES_INTERNES' = TABLE ;
TAB1.'BLOCAGES_MECANIQUES' =CL;
TAB1.'MODELE' = MOD0;
TAB1.'CARACTERISTIQUES' = MAT0;
TAB1.'CHARGEMENT' = CHA0;
TAB1.'TEMPS_CALCULES' = LTPC;
* TAB1.'TEMPERATURES' . 0 = THE1;
TAB1.VARIABLES_INTERNES.0 = VAR0;
*TAB1.'GRANDS_DEPLACEMENTS' = VRAI;
* TAB1.'GRANDES_DEFORMATIONS' = VRAI;
TAB1.'TEMPS_SAUVES' = LTPS;
TAB1.'LAGRANGIEN' = 'MOT' 'REACTUALISE';
*TAB1.'CONVERGENCE_FORCEE' = FAUX;
TAB1.'CONVERGENCE_FORCEE' = VRAI;

PASAPAS TAB1;

LIST TAB1 ;

TAB2 = TAB1.CONTRAINTES;
TAB3 = TAB1.VARIABLES_INTERNES;
TAB4 = TAB1.DEPLACEMENTS;
TAB5 = TAB1.REACTIONS;

LIST TAB4 ;

NN = DIME (TAB2);
MESS NN;
DEF   = PROG;
CON   = PROG;
VMIS0 = PROG;
DEFP  = PROG;
TRIAX = PROG;

I = 0;

MAILLAGE = EXTR (TAB1 . WTABLE . 'MOD_MEC') 'MAIL' ;
P6 = MAILLAGE POIN 'PROC' (P6) ;
P5 = MAILLAGE POIN 'PROC' (P5) ;
P7 = MAILLAGE POIN 'PROC' (P7) ;
SH = MAILLAGE POIN DROIT P5 P6 0.0001;
PM = MAILLAGE POIN 'PROC' (PM) ;

REPE FFF NN;

AAA = EXTR TAB2.I SMZZ 1 1 1;
CON = CON ET (PROG AAA);
BBB = EXTR TAB3.I 'P' 1 1 1;
DEF = DEF ET (PROG BBB);



DDD = EXTR TAB3.I 'P' 1 1 1;
DEFP = DEFP ET (PROG DDD);

*rea1 = REDU (TAB1.REACTIONS.I) SH;
*LIST rea1;
*foY = MAXI (EXCO 'FZ' (RESU rea1));
*LF = LF ET (PROG foY);

*DEF1 = DEFO V1 (TAB1.DEPLACEMENTS.I) 1.;
*TRAC V1;
*TRAC DEF1 ;
*TRAC (TAB1.REACTIONS.I) DEF1 ;

I = I+1;

FIN FFF;

*LIST DEP;

EV1 = EVOL BLEU MANU 'DEF' DEF 'CONT' CON;
*EV2 = EVOL BLEU MANU 'DEF' DEF 'POROS' POR;
EV3 = EVOL BLEU MANU 'DEFP' DEFP 'CONT' CON;
*EV4 = EVOL BLEU MANU 'DEFP' DEFP 'POROS' POR;
*EVTOT = EV1 ET EV2 ET EV3 ET EV4 ;
EVTOT = EV1 ET EV3 ;


DESS EV1;
*DESS EV2;
DESS EV3;
*DESS EV4;



OPTI SORT TRACTION_AJUSTE;
SORT EXCE EVTOT ;

LDPT = PROG;
LDPT = INSE LDPT 1 (0.);

LTRI = PROG;
LTRI = INSE LTRI 1 (0.);

LF = PROG ;
LF = INSE LF  1 (0.) ;
NBPAS = DIME (TAB1.TEMPS) - 1;

REPE IND NBPAS;

DPT0 = EXTR TAB1.DEPLACEMENTS.&IND UZ P6;
LDPT = LDPT ET (PROG DPT0);
	
REA1 = REDU (TAB1.REACTIONS.&IND) D3;
FOY = MAXI (EXCO 'FZ' (RESU REA1));
LF = LF ET (PROG FOY);

CHEL1 CHEL2 CHEL3 = INVA MOD0 TAB1.CONTRAINTES.&IND ;
VMIS1 = VMIS MOD0 TAB1.CONTRAINTES.&IND ;
VMIS3 = CHAN TYPE VMIS1 SCALAIRE ;
TRI0  = (CHEL1 / 3.) * (VMIS3 ** -1.) ;
TRI1  = CHAN 'NOEUD' MOD0 TRI0 ;
TRI2  = CHAN 'CHPO' MOD0 TRI1 ;
EVTRIAX = EVOL CHPO TRI2 D3 ;
TTRIAX = TABLE;
TTRIAX.&IND = MAXI (EXTR EVTRIAX ORDO);
LTRI = LTRI ET (PROG TTRIAX.&IND);
   
FIN IND;

E_FORCE = EVOL MANU 'DPT (MM)' LDPT 'FORCE (N)' LF;
E_TRIAX = EVOL MANU 'DPT (MM)' LDPT 'TRIAXIALITY' LTRI;
DESS E_FORCE TITR 'FORCE(N)- DPT(MM)';
DESS E_TRIAX TITR 'TRIAXIALITY - DPT(MM)';

OPTI SORT 'evol.csv';
SORT EXCE (E_FORCE ET E_TRIAX);

*FIN;
